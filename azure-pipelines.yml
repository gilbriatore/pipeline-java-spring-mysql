trigger:
  branches:
    include:
      - repository

pool:
  vmImage: 'ubuntu-latest'

variables:
  MYSQL_ROOT_PASS: '12345'
  SPRING_DB_NAME: 'spring'

steps:
  # ✅ Instalar MySQL
  - task: Bash@3
    displayName: 'Instalar MySQL Server'
    inputs:
      targetType: 'inline'
      script: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server

  # ✅ Parar MySQL e subir com --skip-grant-tables
  - task: Bash@3
    displayName: 'Parar MySQL e iniciar com --skip-grant-tables'
    inputs:
      targetType: 'inline'
      script: |
        sudo systemctl stop mysql
        sudo mkdir -p /var/run/mysqld
        sudo chown mysql:mysql /var/run/mysqld
        sudo mysqld_safe --skip-grant-tables &
        
        # Aguarda MySQL iniciar
        sleep 10

  # ✅ Alterar plugin de autenticação do root e definir senha
  - task: Bash@3
    displayName: 'Alterar root e definir senha'
    inputs:
      targetType: 'inline'
      script: |
        mysql -u root <<-EOSQL
          ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}';
          FLUSH PRIVILEGES;
        EOSQL

  # ✅ Parar mysqld_safe e reiniciar MySQL normalmente
  - task: Bash@3
    displayName: 'Reiniciar MySQL normalmente'
    inputs:
      targetType: 'inline'
      script: |
        sudo pkill mysqld
        sleep 5
        sudo systemctl start mysql

  # ✅ Criar banco spring
  - task: Bash@3
    displayName: 'Criar banco de dados spring'
    inputs:
      targetType: 'inline'
      script: |
        mysql -u root -p${MYSQL_ROOT_PASS} -e "CREATE DATABASE IF NOT EXISTS ${SPRING_DB_NAME};"

  # ✅ Testar conexão
  - task: Bash@3
    displayName: 'Testar conexão com banco spring'
    inputs:
      targetType: 'inline'
      script: |
        mysql -u root -p${MYSQL_ROOT_PASS} -e "SHOW DATABASES;"

  # ✅ Build com Maven
  - task: Maven@4
    displayName: 'Build com Maven'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'clean package'

  # ✅ Executar aplicação Spring Boot
  - task: Bash@3
    displayName: 'Executar aplicação Spring Boot'
    inputs:
      targetType: 'inline'
      script: |
        java -jar target/*.jar
